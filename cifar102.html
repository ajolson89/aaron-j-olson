
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CIFAR 102 - Are Machine Learning Models Generalizable</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Shangyun Lv, Brad Nott, Aaron Olson" />
    <meta name="description" content="Analysis of dataset composition and machine learning robustness to new data applied to CIFAR-10 dataset" />
    <meta name="keywords" content="python, gradient boost, decision tree, spark, pyspark">
<!-- Facebook and Twitter integration -->
<meta property="og:site_name" content="Aaron J. Olson - Portfolio"/>
<meta property="og:title" content="CIFAR 102 - Are Machine Learning Models Generalizable"/>
<meta property="og:description" content="Analysis of dataset composition and machine learning robustness to new data applied to CIFAR-10 dataset"/>
<meta property="og:url" content="https://aaron-j-olson.com/cifar102.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-03-08 20:00:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://aaron-j-olson.com/author/shangyun-lv-brad-nott-aaron-olson.html">
<meta property="article:section" content="posts"/>
    <meta property="article:tag" content="python"/>
    <meta property="article:tag" content="gradient boost"/>
    <meta property="article:tag" content="decision tree"/>
    <meta property="article:tag" content="spark"/>
    <meta property="article:tag" content="pyspark"/>
    <meta property="og:image" content="\images\olson.jpg">

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/icomoon.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/bootstrap.css">
    <!-- Flexslider  -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/flexslider.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/style.css">
    <!-- Custom style  -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/custom.css">
    <!-- pygments code highlight -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/css/pygments.css">
    <!-- tipue search -->
    <link rel="stylesheet" href="https://aaron-j-olson.com/theme/tipuesearch/css/tipuesearch.css">

    <!-- Modernizr JS -->
    <script src="https://aaron-j-olson.com/theme/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="/theme/js/respond.min.js"></script>
    <![endif]-->
        <link href="https://aaron-j-olson.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aaron J. Olson - Portfolio Atom">



    </head>
    <body>
    <div id="fh5co-page">
        <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
        <aside id="fh5co-aside" role="complementary" class="border js-fullheight">

            <nav class="fh5co-main-menu" role="navigation">
            </nav>
            <div class="clearfix"></div>
            <h1  id="fh5co-logo">
                <a href="https://aaron-j-olson.com/index.html">
                    <img src="\images\olson.jpg" />
                </a>
            </h1>
            <nav class="fh5co-main-menu" role="navigation">
<ul>
    <!-- home link -->
    <li><a href="https://aaron-j-olson.com/">Home</a></li>

    <!-- page links -->
            <li><a href="https://aaron-j-olson.com/pages/home.html">About Me</a></li>

    <!-- categories -->
        <li><a href="https://aaron-j-olson.com/categories.html">Categories</a></li>

    <!-- tags -->
        <li><a href="https://aaron-j-olson.com/tags.html">Tags</a></li>

    <!-- additional menu items from config -->
        <!-- <li class="nav-title">Misc</li> -->
            <li><a href="https://aaron-j-olson.com/archives.html">Archive</a></li>
            <li><a href="https://aaron-j-olson.com/contact.html">Contact</a></li>

</ul>
            </nav>

<ul id="social">
            <li><a href="https://github.com/ajolson89" alt="Github"><i class="icon-github"></i></a></li>

            <li><a href="https://www.linkedin.com/in/aaron-j-olson/" alt="LinkedIn"><i class="icon-linkedin2"></i></a></li>

</ul>
        </aside>

        <div id="fh5co-main">

    <div class="fh5co-narrow-content article-content">
        <h1 class="fh5co-heading-colored">CIFAR 102 - Are Machine Learning Models Generalizable</h1>

        <div>by
                <a href="author/shangyun-lv-brad-nott-aaron-olson.html">Shangyun Lv, Brad Nott, Aaron Olson</a> - Sun 08 March 2020
        </div>

            <div><span>Tags: </span>
                    <span><a href="https://aaron-j-olson.com/tag/python.html">#python</a> </span>
                    <span><a href="https://aaron-j-olson.com/tag/gradient-boost.html">#gradient boost</a> </span>
                    <span><a href="https://aaron-j-olson.com/tag/decision-tree.html">#decision tree</a> </span>
                    <span><a href="https://aaron-j-olson.com/tag/spark.html">#spark</a> </span>
                    <span><a href="https://aaron-j-olson.com/tag/pyspark.html">#pyspark</a> </span>
            </div>

        <div class="animate-box" data-animate-effect="fadeInLeft">
            <p class="animate-box" data-animate-effect="fadeInLeft"><p>Machine Learning Models has continued to improve performance against many of the best known image datasets (MS COCO, ImageNet, CIFAR...). New models that are best in class may beat former models by slimming margins (~1% accuracy improvement). A recent paper 'Do ImageNet Classifiers Generalize to ImageNet? {https://people.csail.mit.edu/ludwigs/papers/imagenet.pdf} highlighted a drop in performance on a new test set which emulated the datset generation process detailed in both ImageNet and CIFAR10. The authors noted that the drop in accuracy is likely due to a 'generalization gap' in which the model performs very well on the original training and test set - but a new dataset which has some distribution shift has caused a substantial drop in accuracy. </p>
<p>This paper and project seeks to go further based on this analysis, by generating a new training set - once again emulating the dataset generation process outlined in the original CIFAR paper {https://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf}. Fortunately the dataset emulation was detailed thoroughly and given below: </p>
<table><tr>
    <td> <img src="images/cifar102/cifar10learning.JPG" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<p>After assembling a new training dataset we can then use the pre-existing published models to observe accuracy metrics and better understand where specific models, and model architectures can and cannot generalize well. This notebook will be written in the following order: </p>
<ul>
<li>Training Dataset Creation</li>
<li>Model Training</li>
</ul>
<p>We will begin by describing the training datset generation process. We are currently utilizing an intermediary 10k image datset (goal 60k) where 8k are dedicated to training and 2k for testing. Shown below is a flow chart desribing the process to create a valid training dataset: </p>
<table><tr>
    <td> <img src="images/cifar102/workflow.JPG" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<h2>Training Dataset Generation - Query Tiny Images, Candidate Image Collection and Verify Images</h2>
<p>The original CIFAR paper queried tiny images - a dataset containing 80 million images with a large array based on wordnet of nouns to categorize the images. Using a candidate set of keywords the CIFAR paper queried a certain number of images related to 10 categories (for CIFAR10). From these image candidates the image verification protocol previously shown was followed by Amazon Turk mechanical workers. After establishing verified images the dataset was then published. </p>
<p>We will follow a similar protocol using the keywords published in the CIFAR 10.1 paper. From these keywords we collected over 466k candidate images, containing images both within the original CIFAR10 train/test datsets, the CIFAR 10.1 test dataset and a collection of new images - depicted below are the image counts using these keyword distribution: </p>
<table><tr>
    <td> <img src="images/cifar102/imagescifar10.JPG" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<p>In order to verify thse images we used the LabelIMG software intended for image classification and object detection. A depiction of the UI is given below: </p>
<p><img src="images/cifar102/labelimg.JPG"></p>
<p>As can be seen - the UI mimics the original UI in which users were shown candidate images and they had to verify if the image belonged to the CIFAR class that was shown. While verifying images the users attempted to follow the first instruction whereby an image belongs to a CIFAR10 class if a user could look at the image and come to the same conclusion as the proposed label. </p>
<p>The code cells below walk through the image query process. Images were written into folders using the structure: CIFAR10class/TinyImagesKeyword/Image01. The users then went through images following close to the same proportion for each keyword in the CIFAR class. </p>
<div class="highlight"><pre><span></span><span class="c1">### Import Required Libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">scipy</span><span class="o">,</span> <span class="nn">scipy.misc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">imshow</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span> <span class="k">as</span> <span class="n">ssim</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>

<span class="n">TinyImagesFilepath</span> <span class="o">=</span> <span class="s1">&#39;E:</span><span class="se">\\</span><span class="s1">TinyImages</span><span class="se">\\</span><span class="s1">&#39;</span>
<span class="n">VerifiedImagesFilepath</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">VerifiedImages&#39;</span>
<span class="n">CIFAR10Filepath</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">datasets</span><span class="se">\\</span><span class="s1">cifar10</span><span class="se">\\</span><span class="s1">&#39;</span>
<span class="n">CIFAR101Filepath</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">&#39;</span>
</pre></div>


<p>The cell below uses the kyword_counts_v7 json file from the CIFAR10.1 dataset assembly process. Our work has identified that the original CIFAR10 dataset used additional keywords with low overall total images. We will include analysis of the images that were sourced from different keywords elsewhere. For now this provides the basis for the 10k dataset, and should we choose to include the additional found keywords in our 60k dataset we will work through the new assembly process</p>
<div class="highlight"><pre><span></span><span class="c1">### Import Keywords from keyword_counts file published from CIFAR10.1</span>
<span class="n">cifar_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">keyword_counts_v7.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
            <span class="n">cifar_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">keyword_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Loop through metadata file and write keyword and index to default dict</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">keywords</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;tiny_metadata.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">768</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">80</span><span class="p">],</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">:</span><span class="mi">185</span><span class="p">],</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Write meta file containing index_filename</span>
            <span class="n">keywords</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Using keywords dict - loop through indexes of images and save image array to default dict</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="c1"># extract index from meta dictionary</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">*</span> <span class="mi">3072</span>
        <span class="n">reshape</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;tiny_images.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3072</span> <span class="o">*</span> <span class="n">num_images</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reshape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_images</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">num_images</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">images</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete!&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">AOlson</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Continuum</span>\<span class="n">anaconda3</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">ipykernel_launcher</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">binary</span> <span class="n">mode</span> <span class="n">of</span> <span class="n">fromstring</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="p">,</span> <span class="k">as</span> <span class="n">it</span> <span class="n">behaves</span> <span class="n">surprisingly</span> <span class="n">on</span> <span class="nb">unicode</span> <span class="n">inputs</span><span class="o">.</span> <span class="n">Use</span> <span class="n">frombuffer</span> <span class="n">instead</span>
  <span class="kn">from</span> <span class="nn">ipykernel</span> <span class="kn">import</span> <span class="n">kernelapp</span> <span class="k">as</span> <span class="n">app</span>


<span class="n">Complete</span><span class="err">!</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Cell generates a plot based on the 10 classes of CIFAR and total number of images found from Tiny images keyword query</span>

<span class="n">cifar_counts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;airplane&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;automobile&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;bird&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;deer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;dog&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;frog&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;horse&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;ship&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;truck&#39;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">keyd</span><span class="p">,</span> <span class="n">valued</span> <span class="ow">in</span> <span class="n">cifar_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valued</span><span class="p">:</span>
            <span class="n">cifar_counts</span><span class="p">[</span><span class="n">keyd</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar_counts</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar_counts</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="c1"># # for python 2.x:</span>
<span class="c1"># plt.bar(range(len(D)), D.values(), align=&#39;center&#39;)  # python 2.x</span>
<span class="c1"># plt.xticks(range(len(D)), D.keys())  # in python 2.x</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Number Images per Class&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_7_0.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<div class="highlight"><pre><span></span><span class="c1">### Cell generates a plot based on the 10 classes of CIFAR and total number of images found from Tiny images keyword query</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cifar_counts</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">cifar_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Images per CIFAR class&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;CIFAR Class&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Image Count&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Text(0, 0.5, &#39;Image Count&#39;)</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_8_1.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<div class="highlight"><pre><span></span><span class="c1">### Write both dictionaries to pickle files</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;data.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;meta.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Use data and metadata bin files to preview image by index number</span>
<span class="c1">### This cell only shows single images and doesn&#39;t process the dictinoaries as a whole</span>

<span class="n">reshape</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">data_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;tiny_images.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">data_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3072</span> <span class="o">*</span> <span class="n">num_images</span><span class="p">)</span> 
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;data.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>


<span class="n">offset</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">*</span> <span class="mi">768</span>
<span class="n">meta_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;tiny_metadata.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">meta_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">meta_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">768</span><span class="o">*</span><span class="n">num_images</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;meta.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="n">keyword</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">80</span><span class="p">],</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">:</span><span class="mi">185</span><span class="p">],</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">185</span><span class="p">:</span><span class="mi">187</span><span class="p">]</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">187</span><span class="p">:</span><span class="mi">189</span><span class="p">]</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">189</span><span class="p">:</span><span class="mi">190</span><span class="p">]</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">190</span><span class="p">:</span><span class="mi">222</span><span class="p">]</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">222</span><span class="p">:</span><span class="mi">232</span><span class="p">]</span>
<span class="n">thumbnail</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">232</span><span class="p">:</span><span class="mi">432</span><span class="p">]</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">432</span><span class="p">:</span><span class="mi">760</span><span class="p">]</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">760</span><span class="p">:</span><span class="mi">764</span><span class="p">]</span>
<span class="n">indpage</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">764</span><span class="p">:</span><span class="mi">768</span><span class="p">]</span>
<span class="n">indengine</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">768</span><span class="p">:</span><span class="mi">762</span><span class="p">]</span>
<span class="n">indoverall</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">762</span><span class="p">:</span><span class="mi">764</span><span class="p">]</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">764</span><span class="p">:</span><span class="mi">768</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">thumbnail</span><span class="p">,</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">indpage</span><span class="p">,</span> <span class="n">indengine</span><span class="p">,</span><span class="n">indoverall</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">young</span> <span class="n">young_s_000001</span><span class="p">.</span><span class="n">png</span> <span class="n">b</span><span class="s1">&#39; 2&#39;</span> <span class="n">b</span><span class="s1">&#39;00&#39;</span> <span class="n">b</span><span class="s1">&#39;6&#39;</span> <span class="n">b</span><span class="s1">&#39; 14:07:07 +0000       google    &#39;</span> <span class="n">b</span><span class="s1">&#39;http://ima&#39;</span> <span class="n">b</span><span class="s1">&#39;ges.google.com/images?q=tbn:Z9bf4ecp_8ej2M:http://www.uncwil.edu/honors/small%252003/smBlair%2520Young.JPG                                                                                    http://www&#39;</span> <span class="n">b</span><span class="s1">&#39;.uncwil.edu/honors/small%252003/smBlair%2520Young.JPG                                                                                                                                                                                                                                                                         1   1   1 &#39;</span> <span class="n">b</span><span class="s1">&#39;  1 &#39;</span> <span class="n">b</span><span class="s1">&#39;  -1&#39;</span> <span class="n">b</span><span class="s1">&#39;&#39;</span> <span class="n">b</span><span class="s1">&#39;1 &#39;</span> <span class="n">b</span><span class="s1">&#39;  -1&#39;</span>


<span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">AOlson</span><span class="err">\</span><span class="n">AppData</span><span class="err">\</span><span class="k">Local</span><span class="err">\</span><span class="n">Continuum</span><span class="err">\</span><span class="n">anaconda3</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="err">\</span><span class="n">ipykernel_launcher</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span> <span class="n">DeprecationWarning</span><span class="p">:</span> <span class="n">The</span> <span class="nb">binary</span> <span class="k">mode</span> <span class="k">of</span> <span class="n">fromstring</span> <span class="k">is</span> <span class="n">deprecated</span><span class="p">,</span> <span class="k">as</span> <span class="n">it</span> <span class="n">behaves</span> <span class="n">surprisingly</span> <span class="k">on</span> <span class="n">unicode</span> <span class="n">inputs</span><span class="p">.</span> <span class="n">Use</span> <span class="n">frombuffer</span> <span class="k">instead</span>
  <span class="o">#</span> <span class="n">Remove</span> <span class="n">the</span> <span class="n">CWD</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">path</span> <span class="n">while</span> <span class="n">we</span> <span class="k">load</span> <span class="n">stuff</span><span class="p">.</span>





<span class="nb">array</span><span class="p">([</span><span class="mi">65</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="p">...,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Load pickle file of images by keword</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;data.pickle&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">filename</span> <span class="o">=</span> <span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;meta.pickle&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">dict_keys([&#39;abandoned_ship&#39;, &#39;accentor&#39;, &#39;aerial_ladder_truck&#39;, &#39;aeroplane&#39;, &#39;airbus&#39;, &#39;airliner&#39;, &#39;airplane&#39;, &#39;alauda_arvensis&#39;, &#39;alces_alces&#39;, &#39;alley_cat&#39;, &#39;alytes_obstetricans&#39;, &#39;ambulance&#39;, &#39;american_elk&#39;, &#39;american_saddle_horse&#39;, &#39;american_toad&#39;, &#39;amphibious_aircraft&#39;, &#39;anthus_pratensis&#39;, &#39;anuran&#39;, &#39;appaloosa&#39;, &#39;apteryx&#39;, &#39;arab&#39;, &#39;arabian&#39;, &#39;articulated_lorry&#39;, &#39;attack_aircraft&#39;, &#39;auto&#39;, &#39;automobile&#39;, &#39;banana_boat&#39;, &#39;barge&#39;, &#39;barking_deer&#39;, &#39;barking_frog&#39;, &#39;barren_ground_caribou&#39;, &#39;beach_wagon&#39;, &#39;biplane&#39;, &#39;bird&#39;, &#39;bird_of_passage&#39;, &#39;blenheim_spaniel&#39;, &#39;boat&#39;, &#39;bookmobile&#39;, &#39;brocket&#39;, &#39;broodmare&#39;, &#39;buckskin&#39;, &#39;bufo&#39;, &#39;bufo_americanus&#39;, &#39;bufo_boreas&#39;, &#39;bufo_bufo&#39;, &#39;bufo_calamita&#39;, &#39;bufo_debilis&#39;, &#39;bufo_marinus&#39;, &#39;bufo_microscaphus&#39;, &#39;bufo_speciosus&#39;, &#39;bufo_viridis&#39;, &#39;bullfrog&#39;, &#39;cab&#39;, &#39;cabin_cruiser&#39;, &#39;camion&#39;, &#39;canis_familiaris&#39;, &#39;capreolus_capreolus&#39;, &#39;car&#39;, &#39;car_transporter&#39;, &#39;cargo_ship&#39;, &#39;cargo_vessel&#39;, &#39;caribou&#39;, &#39;cascades_frog&#39;, &#39;cassowary&#39;, &#39;cat&#39;, &#39;cavalry_horse&#39;, &#39;cervus_elaphus&#39;, &#39;cervus_sika&#39;, &#39;cervus_unicolor&#39;, &#39;chihuahua&#39;, &#39;cock&#39;, &#39;compact&#39;, &#39;compact_car&#39;, &#39;container_ship&#39;, &#39;container_vessel&#39;, &#39;containership&#39;, &#39;convertible&#39;, &#39;coupe&#39;, &#39;cow_pony&#39;, &#39;crapaud&#39;, &#39;cruiser&#39;, &#39;cur&#39;, &#39;dama_dama&#39;, &#39;dawn_horse&#39;, &#39;deer&#39;, &#39;delivery_truck&#39;, &#39;delivery_van&#39;, &#39;dive_bomber&#39;, &#39;dog&#39;, &#39;domestic_cat&#39;, &#39;domestic_dog&#39;, &#39;dredger&#39;, &#39;dromaius_novaehollandiae&#39;, &#39;dump_truck&#39;, &#39;dumper&#39;, &#39;dunnock&#39;, &#39;dustcart&#39;, &#39;elephant_bird&#39;, &#39;elk&#39;, &#39;emu&#39;, &#39;emu_novaehollandiae&#39;, &#39;english_toy_spaniel&#39;, &#39;estate_car&#39;, &#39;european_elk&#39;, &#39;european_toad&#39;, &#39;fallow_deer&#39;, &#39;fawn&#39;, &#39;feist&#39;, &#39;felis_catus&#39;, &#39;felis_domesticus&#39;, &#39;female_horse&#39;, &#39;ferry&#39;, &#39;ferryboat&#39;, &#39;fighter&#39;, &#39;fighter_aircraft&#39;, &#39;finch&#39;, &#39;fire_engine&#39;, &#39;fire_truck&#39;, &#39;fireboat&#39;, &#39;flightless_bird&#39;, &#39;floatplane&#39;, &#39;flying_bird&#39;, &#39;freighter&#39;, &#39;frog&#39;, &#39;funny_wagon&#39;, &#39;gamecock&#39;, &#39;garbage_truck&#39;, &#39;gelding&#39;, &#39;grass_frog&#39;, &#39;green_frog&#39;, &#39;guard_boat&#39;, &#39;hangar_queen&#39;, &#39;hen&#39;, &#39;honey_eater&#39;, &#39;horse&#39;, &#39;hospital_ship&#39;, &#39;house_cat&#39;, &#39;houseboat&#39;, &#39;hydrofoil&#39;, &#39;iceboat&#39;, &#39;icebreaker&#39;, &#39;japanese_deer&#39;, &#39;japanese_spaniel&#39;, &#39;jetliner&#39;, &#39;jumbo_jet&#39;, &#39;jumbojet&#39;, &#39;king_charles_spaniel&#39;, &#39;kiwi&#39;, &#39;ladder_truck&#39;, &#39;lapdog&#39;, &#39;lark&#39;, &#39;laundry_truck&#39;, &#39;leopard_frog&#39;, &#39;leptodactylid&#39;, &#39;leptodactylus_pentadactylus&#39;, &#39;liberty_ship&#39;, &#39;lightship&#39;, &#39;lipizzan&#39;, &#39;lippizan&#39;, &#39;lippizaner&#39;, &#39;lorry&#39;, &#39;male_horse&#39;, &#39;maltese&#39;, &#39;maltese_dog&#39;, &#39;mare&#39;, &#39;meadow_pipit&#39;, &#39;merchant_ship&#39;, &#39;merchantman&#39;, &#39;midwife_toad&#39;, &#39;minesweeper&#39;, &#39;mongrel&#39;, &#39;monoplane&#39;, &#39;moose&#39;, &#39;motorboat&#39;, &#39;motorcar&#39;, &#39;mouser&#39;, &#39;moving_van&#39;, &#39;mule_deer&#39;, &#39;multiengine_airplane&#39;, &#39;muntjac&#39;, &#39;musk_deer&#39;, &#39;mutt&#39;, &#39;nandu&#39;, &#39;natterjack&#39;, &#39;night_bird&#39;, &#39;norfolk_wherry&#39;, &#39;odocoileus_hemionus&#39;, &#39;oil_tanker&#39;, &#39;ostrich&#39;, &#39;packet_boat&#39;, &#39;panel_truck&#39;, &#39;pantechnicon&#39;, &#39;passenger_ship&#39;, &#39;passerine&#39;, &#39;peke&#39;, &#39;pekinese&#39;, &#39;pekingese&#39;, &#39;pickerel_frog&#39;, &#39;pilot_boat&#39;, &#39;pipit&#39;, &#39;plane&#39;, &#39;plantation_walking_horse&#39;, &#39;pleasure_boat&#39;, &#39;pleasure_craft&#39;, &#39;police_boat&#39;, &#39;police_cruiser&#39;, &#39;pontoon&#39;, &#39;powerboat&#39;, &#39;prancer&#39;, &#39;propeller_plane&#39;, &#39;prunella_modularis&#39;, &#39;puppy&#39;, &#39;quarter_horse&#39;, &#39;racing_boat&#39;, &#39;rana_cascadae&#39;, &#39;rana_catesbeiana&#39;, &#39;rana_clamitans&#39;, &#39;rana_pipiens&#39;, &#39;rana_temporaria&#39;, &#39;rangifer_caribou&#39;, &#39;rangifer_tarandus&#39;, &#39;ratite&#39;, &#39;reconnaissance_plane&#39;, &#39;red_deer&#39;, &#39;reindeer&#39;, &#39;rhea&#39;, &#39;rhea_americana&#39;, &#39;riding_horse&#39;, &#39;rig&#39;, &#39;river_boat&#39;, &#39;roe_deer&#39;, &#39;rowboat&#39;, &#39;saddle_horse&#39;, &#39;sambar&#39;, &#39;scow&#39;, &#39;sea_boat&#39;, &#39;seaplane&#39;, &#39;semi&#39;, &#39;ship&#39;, &#39;shooting_brake&#39;, &#39;sika&#39;, &#39;skylark&#39;, &#39;songbird&#39;, &#39;sound_truck&#39;, &#39;southwestern_toad&#39;, &#39;spadefoot&#39;, &#39;sparrow&#39;, &#39;speedboat&#39;, &#39;spring_frog&#39;, &#39;stag&#39;, &#39;stallion&#39;, &#39;station_wagon&#39;, &#39;stealth_bomber&#39;, &#39;stealth_fighter&#39;, &#39;struthio_camelus&#39;, &#39;stud_mare&#39;, &#39;studhorse&#39;, &#39;supertanker&#39;, &#39;tabby&#39;, &#39;tabby_cat&#39;, &#39;tailed_frog&#39;, &#39;tandem_trailer&#39;, &#39;tank_ship&#39;, &#39;tanker&#39;, &#39;taxi&#39;, &#39;tennessee_walker&#39;, &#39;tennessee_walking_horse&#39;, &#39;texas_toad&#39;, &#39;tip_truck&#39;, &#39;tipper&#39;, &#39;tipper_lorry&#39;, &#39;tipper_truck&#39;, &#39;toad&#39;, &#39;toad_frog&#39;, &#39;tomcat&#39;, &#39;tow_truck&#39;, &#39;toy&#39;, &#39;toy_dog&#39;, &#39;toy_spaniel&#39;, &#39;tractor_trailer&#39;, &#39;trailer_truck&#39;, &#39;transporter&#39;, &#39;truck&#39;, &#39;trucking_rig&#39;, &#39;true_cat&#39;, &#39;true_frog&#39;, &#39;true_toad&#39;, &#39;tug&#39;, &#39;tugboat&#39;, &#39;twinjet&#39;, &#39;wagon&#39;, &#39;wagtail&#39;, &#39;walking_horse&#39;, &#39;wapiti&#39;, &#39;western_toad&#39;, &#39;woodland_caribou&#39;, &#39;wrecker&#39;, &#39;yosemite_toad&#39;])</span>
</pre></div>


<h3>Create folders to save images</h3>
<h3>Markdown File to prevent running</h3>
<p>filepath = TinyImgesFilepath + 'ImagesCIFARVerified\'</p>
<h1>for key in images.keys():</h1>
<h1>os.mkdir(filepath + key)</h1>
<p>for key in cifar_dict.keys():
    os.mkdir(filepath + key)</p>
<p>for key in images.keys():
    for keyd, valued in cifar_dict.items():
        if key in valued:
            break
    filepath2 = filepath + keyd + '\'
    os.mkdir(filepath2 + key)</p>
<div class="highlight"><pre><span></span><span class="c1">### Save to image</span>
<span class="c1">### Also loops through and generates cifar filepaths for the local save - </span>
<span class="c1">###       this is included in our larger CIFAR102 dictionary for reference</span>
<span class="n">cifar_filepaths</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cifar_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">keyd</span><span class="p">,</span> <span class="n">valued</span> <span class="ow">in</span> <span class="n">cifar_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>    <span class="c1"># for name, age in dictionary.iteritems():  (for Python 2.x)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valued</span><span class="p">:</span>
            <span class="n">cifar_key</span> <span class="o">=</span> <span class="n">keyd</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">images</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">cifar_filepaths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cifar_key</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
<span class="c1">#         im = Image.fromarray(v)</span>
<span class="c1">#         im.save(TinyImgesFilepath + &#39;ImagesCIFAR\\&#39; + cifar_key + &#39;\\&#39; + key + &#39;\\&#39; + key + &#39;_&#39; + str(x) + &#39;.jpg&#39;)</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>


<h2>Training Dataset Generation - Analyzing Verified Images</h2>
<p>After verifying images, we totaled approximately 18k verified images amongst the 10 classes in CIFAR10. Below we show how many images were found in each CIFAR10 class: </p>
<p><img src="verifydataset.JPG"></p>
<p>From this list of verified images, it was then necessary to remove duplicates within the verified images and remove duplicates to the CIFAR10 and CIFAR10.1 test sets. It was important to remove duplicates to the former test sets because it is intended to utilize CIFAR10, CIFAR10.1 and CIFAR10.2 datasets to understand model generalization. If CIFAR10.2 training dataset had images contained in the other datasets test set the accuracy would be incorrectly high. </p>
<p>Below we read in the verified images, and remove duplicates - this code can be found more thoroughly in both the PrepTinyImages notebook as well as the df_overlap_assembly notebook: </p>
<h3>Reading in Verified Images</h3>
<p>At this point we have worked through a large number of images and verified which images in fact do belong the CIFAR class the original keyword query had assigned. We now need to read in the verified images in order to understand count / proportion by class and keyword, as well as assembling our 10k and eventually 60k datasets.  </p>
<div class="highlight"><pre><span></span><span class="c1">### Read in verified xml data </span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="n">cifar</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">verified_images</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">tinyimages</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>


<span class="c1">### cif contains dictionary with # keywords per class</span>
<span class="n">cif</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;airplane&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
      <span class="s1">&#39;automobile&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
      <span class="s1">&#39;bird&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
      <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="s1">&#39;deer&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="s1">&#39;dog&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> 
      <span class="s1">&#39;frog&#39;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span>
      <span class="s1">&#39;horse&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
      <span class="s1">&#39;ship&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
      <span class="s1">&#39;truck&#39;</span><span class="p">:</span> <span class="mi">34</span><span class="p">}</span>

<span class="n">extension</span> <span class="o">=</span> <span class="s1">&#39;xml&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">VerifiedImagesFilepath</span><span class="p">)</span>
<span class="n">xmlfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extension</span><span class="p">))</span>
<span class="n">xmlfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">VerifiedImagesFilepath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xmlfiles</span><span class="p">]</span>

<span class="c1"># tinyimages: dictinoary with keys = keywords and values = count</span>
<span class="c1"># cifar: dictionary with keys = class and values = count</span>
<span class="c1"># verified_images: dictionary with keys = cifar class and values = list of truncated filename</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">xmlfiles</span><span class="p">:</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
    <span class="n">path</span>  <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tinyimages</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cifar</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">verified_images</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">tinyimages</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cifar</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">verified_images</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Find duplicate images amongst our verified images</span>

<span class="n">dropout</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">:</span>
    <span class="n">key_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;ImagesCIFAR</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">key_images</span><span class="p">:</span>
            <span class="n">dropout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dropout</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dropout</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">ship</span><span class="o">:</span> <span class="mi">11</span>
<span class="n">bird</span><span class="o">:</span> <span class="mi">149</span>
<span class="n">truck</span><span class="o">:</span> <span class="mi">19</span>
<span class="n">airplane</span><span class="o">:</span> <span class="mi">31</span>
<span class="n">deer</span><span class="o">:</span> <span class="mi">7</span>
<span class="n">cat</span><span class="o">:</span> <span class="mi">15</span>
<span class="n">frog</span><span class="o">:</span> <span class="mi">148</span>
<span class="n">automobile</span><span class="o">:</span> <span class="mi">43</span>
<span class="n">horse</span><span class="o">:</span> <span class="mi">70</span>
<span class="n">dog</span><span class="o">:</span> <span class="mi">4</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Understand how many images were duplicates and how many remain in dataset</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dropout</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dropout</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After duplicate removal&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Original</span>
<span class="c">ship: 1877</span>
<span class="c">bird: 4031</span>
<span class="c">truck: 1442</span>
<span class="c">airplane: 2913</span>
<span class="c">deer: 1431</span>
<span class="c">cat: 1414</span>
<span class="c">frog: 2931</span>
<span class="c">automobile: 2219</span>
<span class="c">horse: 2917</span>
<span class="c">dog: 1285</span>
<span class="err">After duplicate removal</span>
<span class="c">ship: 1866</span>
<span class="c">bird: 3882</span>
<span class="c">truck: 1423</span>
<span class="c">airplane: 2882</span>
<span class="c">deer: 1424</span>
<span class="c">cat: 1399</span>
<span class="c">frog: 2783</span>
<span class="c">automobile: 2176</span>
<span class="c">horse: 2847</span>
<span class="c">dog: 1281</span>
</pre></div>


<h3>Copy verified images from original folder structure to verified folder</h3>
<h3>Not necessary given our dataset = dictionary</h3>
<h3>Converted to Markdown to prevent running</h3>
<p>import shutil
for key in verified_images:
    for v in verified_images[key]:
        shutil.copyfile(TinyImagesFilepath + 'ImagesCIFAR\' + v, 'E:\TinyImages\ImagesCIFARVerified\' + v)</p>
<div class="highlight"><pre><span></span><span class="c1">### Display statistics based on count of dropouts</span>

<span class="n">dropoutper</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dropout</span><span class="p">:</span>
    <span class="n">dropoutper</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">cifar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dropoutper</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">dropoutper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Proportion Duplicate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;CIFAR Class&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Image Count&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">TypeError</span>                                 <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">33</span><span class="o">-</span><span class="n">cdf923568307</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="mi">3</span> <span class="n">dropoutper</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
      <span class="mi">4</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dropout</span><span class="p">:</span>
<span class="o">----&gt;</span> <span class="mi">5</span>     <span class="n">dropoutper</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">cifar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
      <span class="mi">6</span> 
      <span class="mi">7</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>


<span class="ne">TypeError</span><span class="p">:</span> <span class="n">unsupported</span> <span class="n">operand</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="o">/</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span> <span class="ow">and</span> <span class="s1">&#39;float&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Display image count after removing duplicates</span>
<span class="n">image_count</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">image_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_images</span><span class="p">)),</span> <span class="n">image_count</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_images</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">verified_images</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Image Count Post Duplicate Removal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Create master dictionary for CIFAR102</span>
<span class="c1">### dict_keys([b&#39;labels&#39;, b&#39;data&#39;, b&#39;filenames&#39;])</span>


<span class="n">cifar_class_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;airplane&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;automobile&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;bird&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;cat&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;deer&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;dog&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                    <span class="s1">&#39;frog&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
                    <span class="s1">&#39;horse&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span>
                    <span class="s1">&#39;ship&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                    <span class="s1">&#39;truck&#39;</span><span class="p">:</span><span class="mi">9</span><span class="p">}</span>

<span class="n">cifar102</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># Loop through images dictionary - referenced by </span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verified_images</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">cifar_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">tiny_key</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">cifar_filepaths</span><span class="p">[</span><span class="n">tiny_key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">tiny_key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cifar_class_dict</span><span class="p">[</span><span class="n">cifar_key</span><span class="p">])</span>
        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">tiny_key</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cifar_key</span><span class="p">)</span>
        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;tinykeyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiny_key</span><span class="p">)</span>
        <span class="n">cifar102</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;localfilename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="n">cifar102</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Save CIFAR102 dictinoary</span>
<span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;cifar102_10kv2.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cifar102</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<h3>Load Image Data: Tiny Images Subset</h3>
<p>466,009 images that match the same keyword distribution used construct the CIFAR-10 dataset</p>
<p><strong>Note:</strong> This subset was created via a separate task on a local machine through comparing CIFAR-10 keywords to line-by-line read of a Tiny Images dataset binary file </p>
<p>Data subset (dictionary) format:</p>
<div class="highlight"><pre><span></span><span class="n">Keys</span><span class="o">:</span> <span class="n">Tiny</span> <span class="n">Images</span> <span class="n">keywords</span>
<span class="n">Values</span><span class="o">:</span> <span class="n">list</span> <span class="n">of</span> <span class="n">numpy</span> <span class="n">arrays</span> <span class="o">(</span><span class="mi">32</span><span class="n">x32x3</span> <span class="n">images</span><span class="o">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Load subset pickle file</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># prefix = &#39;data/tinyimage/function-test/data.pickle&#39;</span>

<span class="c1"># #response = client.get_object(Bucket=bucket, Key=prefix)</span>
<span class="c1"># response = s3.get_object(Bucket=bucket, Key=prefix)</span>

<span class="c1"># subset_data = pickle.loads(response[&#39;Body&#39;].read())</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Load from local</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;data.pickle&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">subset_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tiny Images subset pickle loaded in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total images: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subset_data</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Tiny Images subset pickle loaded in 0.0 seconds</span>
<span class="err">Total images: 466009</span>
</pre></div>


<h3>Process Image Arrays: Tiny Images Subset</h3>
<ol>
<li>
<p>Flatten individual image arrays and convert to tuples; Store all images as a single list of tuples</p>
<p><strong>Note:</strong> This supports comparisons (e.g., np.unique, pd.DataFrame.drop_duplicates, etc.) since arrays are not hashable</p>
<p><strong>Alternatively:</strong> you could convert the arrays <strong>in-place</strong> (within the dictionary that was loaded in the previous step) rather than creating a new list object.</p>
<p>I create new lists here, but later when I load our verified images I just convert in-place. The first approach preserves the original data, the second conserves RAM.</p>
</li>
<li>
<p>Store all keywords for each image separately to use as a DataFrame column</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="c1"># Process image arrays</span>
<span class="c1"># - convert and store image arrays in a single list</span>
<span class="c1"># - store image keyword labels separately</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">tiny_img_subset</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">subset_data</span><span class="p">:</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">subset_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]]</span>

    <span class="n">tiny_img_subset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">key_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]))])</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total images: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiny_img_subset</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Total images: 466009</span>
<span class="err">Wall time: 156.7 seconds</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Quick check for exact duplicates</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">num_no_duplicates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">({</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tiny_img_subset</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total exact duplicates: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiny_img_subset</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_no_duplicates</span><span class="p">))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Total exact duplicates: 11305</span>
<span class="err">Wall time: 405.4 seconds</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># assemble a dataframe ready for merging with CIFAR-10</span>

<span class="n">df_tiny_img</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tiny_img_subset</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tiny_keyword&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">                                           img_array    tiny_keyword</span>
<span class="err">0  (239, 239, 247, 236, 236, 244, 236, 236, 243, ...  abandoned_ship</span>
<span class="err">1  (239, 229, 219, 240, 230, 220, 241, 231, 221, ...  abandoned_ship</span>
<span class="err">2  (198, 205, 226, 195, 201, 222, 195, 201, 222, ...  abandoned_ship</span>
<span class="err">3  (152, 194, 218, 150, 191, 215, 152, 193, 216, ...  abandoned_ship</span>
<span class="err">4  (195, 201, 191, 144, 151, 133, 112, 121, 91, 1...  abandoned_ship</span>
<span class="err">(466009, 2)</span>
</pre></div>


<h3>Load CIFAR10 Images</h3>
<div class="highlight"><pre><span></span><span class="c1"># Load CIFAR-10 data batches</span>

<span class="n">batch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">batch_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;test_batch&#39;</span><span class="p">)</span>

<span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">batch_id</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batch_names</span><span class="p">:</span>
<span class="c1">#     prefix = &#39;data/cifar10/cifar-10-batches-py/&#39; + batch</span>
<span class="c1">#     response = s3.get_object(Bucket=bucket, Key=prefix)</span>
<span class="c1">#     batches.append(pickle.loads(response[&#39;Body&#39;].read(), encoding=&#39;bytes&#39;))</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">CIFAR10_Filepath</span> <span class="o">+</span> <span class="n">batch</span>
    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">))</span>

    <span class="n">batch_id</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">batch</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)])</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All CIFAR-10 training batches &amp; test batch loaded in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">---------------------------------------------------------------------------</span>

<span class="n">NameError</span>                                 <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="k">call</span> <span class="k">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="k">input</span><span class="o">-</span><span class="mi">41</span><span class="o">-</span><span class="mi">67</span><span class="n">f09ce486c6</span><span class="o">&gt;</span> <span class="k">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
     <span class="mi">14</span> <span class="o">#</span>     <span class="n">batches</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">].</span><span class="k">read</span><span class="p">(),</span> <span class="k">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">))</span>
     <span class="mi">15</span> 
<span class="c1">---&gt; 16     filename = CIFAR10_Filepath + batch</span>
     <span class="mi">17</span>     <span class="n">batches</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">))</span>
     <span class="mi">18</span>


<span class="n">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s1">&#39;CIFAR10_Filepath&#39;</span> <span class="k">is</span> <span class="k">not</span> <span class="k">defined</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Load CIFAR-10 meta</span>
<span class="c1"># - The only thing we will use from the CIFAR-10 meta data is &#39;label_names&#39;</span>
<span class="c1"># - We want to convert each image&#39;s label number to a label name and use that in a column of the dataframe</span>

<span class="c1"># prefix_meta = &#39;data/cifar10/cifar-10-batches-py/batches.meta&#39;</span>
<span class="c1"># response_meta = s3.get_object(Bucket=bucket, Key=prefix_meta)</span>
<span class="c1"># CIFAR_10_meta = pickle.loads(response_meta[&#39;Body&#39;].read())</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">CIFAR10_Filepath</span> <span class="o">+</span> <span class="s1">&#39;batches.meta&#39;</span>
<span class="n">CIFAR_10_meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="c1"># Reshape procedure for each CIFAR-10 batch</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># assemble components for a CIFAR-10 dataframe</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">CIFAR_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">CIFAR_class_names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFAR_10_meta</span><span class="p">[</span><span class="s1">&#39;label_names&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;labels&#39;</span><span class="p">]]</span>

    <span class="n">CIFAR_images</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span>
    <span class="n">CIFAR_class_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total images: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CIFAR_images</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Quick check for exact duplicates (there SHOULD be 0 exact duplicates in CIFAR-10)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">num_no_duplicates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">({</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CIFAR_images</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total exact duplicates: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CIFAR_images</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_no_duplicates</span><span class="p">))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Assemble a CIFAR-10 dataframe</span>

<span class="n">df_CIFAR_10</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">CIFAR_images</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">),</span>
                         <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cifar10_batch_id&#39;</span><span class="p">),</span>
                         <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">CIFAR_class_names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cifar10_class_name&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



<span class="nb">print</span><span class="p">(</span><span class="n">df_CIFAR_10</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_CIFAR_10</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<h3>Remove exact duplicates from Tiny Image subset</h3>
<p>CIFAR-10 already has exact duplicates removed, so we need to do the same for the subset from Tiny Images</p>
<div class="highlight"><pre><span></span><span class="c1"># 11305 duplicates</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original Tiny Images subset row count: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># In list form the exact duplicate count was 11305; verify that count is still valid in dataframe format</span>

<span class="n">duplicates</span> <span class="o">=</span> <span class="n">df_tiny_img</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original Tiny Images subset duplicate count: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicates</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Remove duplicate rows from the Tiny Images subset dataframe (exact duplicates)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_tiny_img</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duplicates found and removed in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New row count: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duplicates removed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">466009</span><span class="o">-</span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>


<h3>Merge: Tiny Images subset and CIFAR-10</h3>
<div class="highlight"><pre><span></span><span class="c1"># add Tiny Images subset indicator column to support filtering</span>
<span class="n">df_tiny_img</span><span class="p">[</span><span class="s1">&#39;tiny_img_subset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_tiny_img</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># add CIFAR-10 indicator column to support filtering</span>
<span class="n">df_CIFAR_10</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_CIFAR_10</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Merge Tiny Images subset dataframe and original CIFAR-10 dataframe</span>
<span class="c1"># - Merge &#39;outer&#39; to catch any CIFAR-10 images that our Tiny Images keyword query might have missed</span>
<span class="c1">#   &quot;Missed&quot; CIFAR-10 images will not have a match in the Tiny Images subset dataframe &#39;img_array&#39; column,</span>
<span class="c1">#   so they will be added to the merged dataframe (indicated as &#39;right_only&#39;)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">df_tiny_img</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_CIFAR_10</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merge completed in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Post merge total row count: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_all</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># subset - duplicates + missed CIFAR_10</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># drop the indicator column; we can get the same information by jointly using the tiny_img_subset and cifar10 indicator columns</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;_merge&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Fill na for tiny_img_subset and cifar10 columns with 0</span>
<span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;tiny_img_subset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># What types of CIFAR-10 images did our Tiny Images query not find?</span>
<span class="n">df_all</span><span class="p">[(</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;tiny_img_subset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)][</span><span class="s1">&#39;cifar10_class_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Define function to name train/test splits</span>

<span class="k">def</span> <span class="nf">split_name</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;data_batch&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;train&#39;</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;test_batch&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;test&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Create column to identify CIFAR-10 train/test split membership</span>
<span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;cifar_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;cifar10_batch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_name</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Drop CIFAR_10_batch_id column</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;cifar10_batch_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;cifar_split&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>


<h3>Load 10k verified images</h3>
<div class="highlight"><pre><span></span><span class="c1"># Load 10k verified image pickle file</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># prefix = &#39;data/cifar102/cifar102_10kv2.pickle&#39;</span>
<span class="c1"># response = s3.get_object(Bucket=bucket, Key=prefix)</span>
<span class="c1"># verified_data = pickle.loads(response[&#39;Body&#39;].read())</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">TinyImagesFilepath</span> <span class="o">+</span> <span class="s1">&#39;cifar102_10kv2.pickle&#39;</span>
<span class="n">verified_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Verified 10k v2 pickle loaded in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total images: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verified_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">])))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">verified_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">verified_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;labels&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Process image arrays</span>
<span class="c1"># - convert and store image arrays IN PLACE</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">verified_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">verified_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>

<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_cifar102_10k</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">verified_data</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># prior to joining, add column to indicate that image is a member of our verified set</span>
<span class="n">df_cifar102_10k</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># rename image column to support joining on the same column name</span>
<span class="n">df_cifar102_10k</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="s1">&#39;img_array&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_overlap</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_cifar102_10k</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;img_array&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Check that merge retained all verified images</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total cifar102: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># convert tuples back to numpy arrays to reduce pickle size</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;img_array&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;img_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wall time: </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># check that if both values are strings, that they are equal</span>
<span class="c1"># - Want to verify that class labels are all the same when they should be</span>


<span class="k">def</span> <span class="nf">check_pairs</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

    <span class="n">cifar10_class_name</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">cifarclass</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">cifar10_class_name</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">cifarclass</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;String label pairs do not match!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First mismatch, row </span><span class="si">{}</span><span class="s1">, labels: (</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All string label pairs match&#39;</span><span class="p">)</span>

<span class="n">check_pairs</span><span class="p">(</span><span class="n">df_overlap</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">merge_cifar_class</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>


<span class="n">df_overlap</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_overlap</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge_cifar_class</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># drop old redundant columns</span>
<span class="n">df_overlap</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;cifar10_class_name&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">overlap</span> <span class="o">=</span> <span class="n">df_overlap</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
<span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">&#39;</span>
<span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;overlap_v2.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">overlap</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
<span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>


<p>After analysis of the overlap between our 18k verified images as well as loading and comparing CIFAR10 and CIFAR10.1 datasets, removing the duplicates in the test set - we have the following overlap between our 18k verified images as well as the CIFAR10 training set: </p>
<p><img src="cifar102overlap.JPG"></p>
<p>As can be seen, roughly 50% of our verified images are contained in the original CIFAR10 training set. In order to minimize overlap, we will first choose images that aren't present in the original CIFAR10 training set, and then fill in the remainder. First we will inspect and remove the 'near' duplicates. </p>
<h2>Training Dataset Generation - Understand and Inspect 'near' duplicate images</h2>
<p>We have previously removed duplicate images from the CIFAR10 test set. We now need to inspect and understand 'near' duplicates to remove these as well. The premise behind removing near duplicates is the same as exact duplicates - the training images may be too similar and prohibit the training from properly generalizing to the task. We compute near duplicate by analyzing the structural similarity (SSIM) as well as Euclidean distance between every image in the verified image dataset against every image in the CIFAR10 and CIFAR10.1 test sets, retaining the maximum similarity value for each verified image. We also retain all SSIM and Euclidean distance metrics in order to understand the distribution of these values and define the threshold value to determine 'near' duplicates. </p>
<div class="highlight"><pre><span></span><span class="c1">### Load Overlap V2 File</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">AOlson</span><span class="se">\\</span><span class="s1">Documents</span><span class="se">\\</span><span class="s1">UC Berkeley MIDS</span><span class="se">\\</span><span class="s1">w210_capstone</span><span class="se">\\</span><span class="s1">CIFAR-10.1</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">overlap_v2.pkl&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">dict_keys([&#39;img_array&#39;, &#39;tiny_keyword&#39;, &#39;tiny_img_subset&#39;, &#39;cifar10&#39;, &#39;cifar_split&#39;, b&#39;labels&#39;, b&#39;filenames&#39;, b&#39;tinykeyword&#39;, b&#39;localfilename&#39;, &#39;cifar102_10k&#39;, &#39;cifarclass&#39;])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Load CIFAR10.1 Dataset</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">Layout</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="n">repo_root</span> <span class="o">=</span> <span class="n">CIFAR101_Filepath</span> <span class="o">+</span> <span class="s2">&quot;code&quot;</span> <span class="c1">#os.path.join(os.getcwd(), &#39;../code&#39;)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repo_root</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">cifar10</span>
<span class="kn">import</span> <span class="nn">utils</span>

<span class="n">cifar_label_names</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cifar10_label_names</span>

<span class="n">version_string</span> <span class="o">=</span> <span class="s1">&#39;v6&#39;</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">tinyimage_indices</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_new_test_data</span><span class="p">(</span><span class="n">version_string</span><span class="p">,</span> <span class="n">load_tinyimage_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_new_images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">reshaped_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="n">num_new_images</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">reshaped_images</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_new_images</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Loaded version </span><span class="si">{}</span><span class="s1"> of the new dataset.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version_string</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">{}</span><span class="s1"> images in the dataset.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="c1"># cifar101 = pd.DataFrame({&#39;data&#39;: images, &#39;labels&#39;: labels})</span>
<span class="n">images_flatten</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">images_flatten</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)))</span>
<span class="n">cifar101</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">images_flatten</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;labels&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cifar101</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cifar101</span><span class="p">[</span><span class="s1">&#39;cifar101&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">cifar101</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Load file to dataframe and rename columns</span>

<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">overlap_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">overlap_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;img_array&#39;</span><span class="p">:</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;filenames&#39;</span><span class="p">:</span> <span class="s1">&#39;filenames&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;tinykeyword&#39;</span><span class="p">:</span> <span class="s1">&#39;tinykeyword&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;localfilename&#39;</span><span class="p">:</span> <span class="s1">&#39;localfilename&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="s1">&#39;labels&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Function to convert class string to int based on original CIFAR dictionary - already completed in overlap_v2 dict</span>
<span class="k">def</span> <span class="nf">transform_cifar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">cifar_class_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;airplane&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;automobile&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;bird&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;cat&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;deer&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;dog&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                    <span class="s1">&#39;frog&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
                    <span class="s1">&#39;horse&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span>
                    <span class="s1">&#39;ship&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                    <span class="s1">&#39;truck&#39;</span><span class="p">:</span><span class="mi">9</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">cifar_class_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)))</span>
<span class="n">overlap_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cifar101</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merge completed in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Post merge total row count: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overlap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

<span class="n">overlap_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;_merge&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Use SSIM to get maximum SSIM value along with index row looping over all verified images and comparing all cifar10 test images</span>
<span class="c1">### Also find minimum euclidean distance</span>

<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;ssim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;ssim_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;euclidean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;euclidean_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

<span class="n">len_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># loop over all verified images</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar102_10k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c1"># apply to all rows in cifar10 test</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[((</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar_split&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar101&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">ssim</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">l</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">overlap_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;ssim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">overlap_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;ssim_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">l</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># apply to all rows in cifar10 test</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[((</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar_split&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar101&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">distance</span><span class="o">.</span><span class="n">euclidean</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">l</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">overlap_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">overlap_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;euclidean_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">l</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Time in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; Precent Complete: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">len_overlap</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>


<span class="n">overlap_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">unpickle</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span>

<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">unpickle</span><span class="p">(</span><span class="n">CIFAR101_Filepath</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">overlap_V2&#39;</span><span class="p">)</span>
<span class="n">overlap_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">&lt;matplotlib.image.AxesImage at 0x215f58518c8&gt;</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_78_1.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<div class="highlight"><pre><span></span><span class="c1">### Generate training dataset</span>
<span class="c1"># cifar102_first_1k = first 1k images for each CIFAR class</span>
<span class="c1"># cifar102_min_overlap = first take images not in CIFAR then take remainder to make 1k images per class</span>

<span class="n">cifar102_first_1k</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">cifar102_min_overlap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">min_overlap</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;cifar10&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">min_overlap</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">min_overlap</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_overlap</span><span class="p">[</span><span class="n">min_overlap</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">1000</span><span class="p">],:]</span>
    <span class="n">cifar102_min_overlap</span> <span class="o">=</span> <span class="n">cifar102_min_overlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="n">class_count</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">cifar_class</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar102_first_1k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar102_first_1k</span><span class="p">[</span><span class="n">cifar102_first_1k</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cifar_class</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">class_count</span><span class="p">):</span>
        <span class="n">cifar102_first_1k</span> <span class="o">=</span> <span class="n">cifar102_first_1k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;cifarclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cifar_class</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">class_count</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cifar102_min_overlap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
        <span class="n">cifar102_min_overlap</span> <span class="o">=</span> <span class="n">cifar102_min_overlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar102_first_1k</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifar102_min_overlap</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">10000 19075 10000</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Create test/train datasets - allowing class balance (ie 800 images in training per CIFAR class)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1">#random state is a seed value</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]))</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">cifar102_min_overlap</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">800</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">### Rotate images in order to make same orientation as CIFAR for proper training loading - also reshape from 3D array to flattened array</span>

<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="s1">&#39;filenames&#39;</span><span class="p">,</span> <span class="s1">&#39;tinykeyword&#39;</span><span class="p">,</span> <span class="s1">&#39;localfilename&#39;</span><span class="p">]</span>
<span class="c1"># cifar102_first_1k = cifar102_first_1k[cols].to_dict()</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cifar102_min_overlap</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
<span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar102_min_overlap</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cifar102_min_overlap_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar102_min_overlap_test</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3072</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
<span class="n">cifar102_min_overlap_test</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">cifar102_min_overlap_test</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifar102_min_overlap_test</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">unpickle</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span>

<span class="n">cifar10_test</span> <span class="o">=</span> <span class="n">unpickle</span><span class="p">(</span><span class="n">CIFAR101_Filepath</span> <span class="o">+</span> <span class="s1">&#39;other_data</span><span class="se">\\</span><span class="s1">test_batch&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_ssim</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Structural Similarity: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ssim</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="n">im2</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">im1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">im2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

<span class="n">plot_ssim</span><span class="p">(</span><span class="n">cifar10_test</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">13</span><span class="p">],</span><span class="n">cifar10_test</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">10</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">Structural Similarity: 0.04</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_82_1.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<div class="highlight"><pre><span></span><span class="c1">### Save datasets</span>

<span class="n">filename</span> <span class="o">=</span> <span class="n">CIFAR101_Filepath</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">other_data</span><span class="se">\\</span><span class="s1">&#39;</span>

<span class="c1"># outfile = open(filename + &#39;cifar102_first_1k&#39;, &#39;wb&#39;)</span>
<span class="c1"># pickle.dump(cifar102_first_1k, outfile)</span>
<span class="c1"># outfile.close()</span>

<span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;cifar102_min_overlap_v1&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cifar102_min_overlap</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span>  <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;cifar102_min_overlap_test_v1&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cifar102_min_overlap_test</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="n">CIFAR10_Filepath</span> <span class="o">+</span> <span class="s1">&#39;other_data</span><span class="se">\\</span><span class="s1">cifar10</span><span class="se">\\</span><span class="s1">batches.meta&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

<span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_cases_per_batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CIFAR10_Filepath</span> <span class="o">+</span> <span class="s1">&#39;other_data</span><span class="se">\\</span><span class="s1">batches.meta&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span>  <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>Cells below load images from various parts of the dataset save to ensure iamge can properly be displayed and matches CIFAR orientation. Last image using vstack and transpose mimics CIFAR10 dataset load process in pytorch class to show proper orientation</p>
<div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="n">CIFAR10_Filepath</span> <span class="o">+</span> <span class="s1">&#39;other_data</span><span class="se">\\</span><span class="s1">&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;ssim&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;SSIM Distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">prop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">d</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Proportion above threshold &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_86_0.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<div class="highlight"><pre><span></span><span class="err">0.0004514723897263169</span>
<span class="err">Proportion above threshold 0.75 is: 0.0005%</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_near_images</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;ssim&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upper_threshold</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">upper_threshold</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upper_threshold</span><span class="p">]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">ssim_index</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;_index&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">image2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ssim_index</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Distance: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
<span class="c1"># df = data[data[&#39;cifar101&#39;].isna()]</span>
<span class="n">plot_near_images</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">7000</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">upper_threshold</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">Distance</span><span class="o">:</span> <span class="mf">7041.4</span>
</pre></div>


<table><tr>
    <td> <img src="images/cifar102/output_87_1.png" alt="Drawing" style="width: 750px;"/> </td>
</tr></table>

<p>The above code was used as a reference in order to understand SSIM / Euclidean values and the image similarity values in order to better understand the threshold: </p>
<p><img src="ssim.JPG"></p>
<p><img src="euclid.JPG"></p>
<p>Because there were inconsistencies in the euclid metric, we chose to prefer SSIM distance metrics and removed anything above the 0.75 threshold. We then generated a 10k dataset minimizing the overlap to the original CIFAR10 training set. From this point we then begin the process of training various models on the CIFAR10, and CIFAR10.2 training sets and comparing accuracy and other metrics amongst the three test sets. </p>
<h2>Model Training</h2>
<p>With a dataset compiled, we began by verifying model accuracies against the state of art models that have published results to CIFAR10 training dataset. Verifying performance is a critical step in order to ensure the code and architecture we are using matches the previosuly published accuracy scores. </p>
<p>We have focused on VGG and ResNet models and will expand to others including AlexNet, Random Features and AutoAugment. After verying model implementation we can then begin to train on the new 10k CIFAR10.2 training dataset and test on CIFAR 10.2 test, CIFAR10.1 and a subset of CIFAR10 test set. We also aim to train on CIFAR10 10k dataset in order to compare accuracy / etc against smaller datasets. Early analysis has shown our 10k dataset tends to have accuracy between 60 and 70% which is in line with prior publications detailing how dataset size impacts model performance</p>
<h2>Future Work</h2>
<p>We will contineu to test different models on the smaller 10k dataset inferring ability to generalize. As previously mentioned, we are likely limited to 70% accuracy upper benchmark due to the smaller training dataset size. It is therefore important to continue to verify images throughout the model testing process with the goal of a 60k image dataset size. This larger training dataset will enable higher accuracy metrics and better understanding of model shortfalls as well as how model accuracy is impacted by different images and/or image categories. </p>
<p>When a 60k dataset is compiled we will continue to test model performance with the implementations that have already been verified to better understand model generalizability. </p></p>
        </div>
    </div>

<div class="fh5co-narrow-content">
<div class="animate-box" data-animate-effect="fadeInLeft">
    <h2><!-- <i class="icon-speech-bubble"></i>  -->Comments</h2>
</div>
<div class="animate-box" data-animate-effect="fadeInLeft">
    <div id="disqus_thread"></div>
</div>

<script>
var disqus_config = function () { 
  this.language = "english";
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript><a href="https://disqus.com/?ref_noscript">Please enable JavaScript to view the comments powered by Disqus.</a></noscript>
<div class="fh5co-footer">
    <p><small>&copy; 2016 Blend Free HTML5. All Rights Reserved.</span> <span>Designed by <a href="http://freehtml5.co/" target="_blank">FreeHTML5.co</a></span>
    <br /><span>Pelican Theme by: <a href="https://github.com/claudio-walser/pelican-fh5co-marble" target="_blank">Claudio Walser</a></span></small></p>

</div>                
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://aaron-j-olson.com/theme/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="https://aaron-j-olson.com/theme/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="https://aaron-j-olson.com/theme/js/bootstrap.min.js"></script>
    <!-- Waypoints -->
    <script src="https://aaron-j-olson.com/theme/js/jquery.waypoints.min.js"></script>
    <!-- Flexslider -->
    <script src="https://aaron-j-olson.com/theme/js/jquery.flexslider-min.js"></script>


    <!-- MAIN JS -->
    <script src="https://aaron-j-olson.com/theme/js/main.js"></script>
    </body>
</html>
